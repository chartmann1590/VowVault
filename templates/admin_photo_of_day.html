{% extends "base.html" %}

{% block title %}Admin - Photo of the Day Contest Management{% endblock %}

{% block extra_styles %}
<style>
    .photo-of-day-admin-header {
        text-align: center;
        margin-bottom: 3rem;
    }
    .photo-of-day-admin-header h1 {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        color: #8b7355;
        margin-bottom: 0.5rem;
    }
    .photo-of-day-admin-header p {
        color: #6b5d54;
        font-size: 1.1rem;
    }
    .admin-stats-grid {
        display: flex;
        gap: 2rem;
        margin-bottom: 2.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    .admin-stat-card {
        background: #f9f5f0;
        border-radius: 15px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.07);
        padding: 2rem 2.5rem;
        text-align: center;
        min-width: 180px;
    }
    .admin-stat-card .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #e91e63;
        margin-bottom: 0.3rem;
    }
    .admin-stat-card .stat-label {
        color: #8b7355;
        font-size: 1.1rem;
    }
    .admin-section-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        margin-bottom: 2.5rem;
        padding: 2.5rem 2rem;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }
    .admin-section-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        color: #8b7355;
        margin-bottom: 2rem;
        text-align: left;
    }
    .contest-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    .admin-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        padding: 0.8rem 1.5rem;
        cursor: pointer;
        transition: background 0.2s;
        text-decoration: none;
        color: #fff;
    }
    .admin-btn.primary {
        background: #e91e63;
    }
    .admin-btn.primary:hover {
        background: #c2185b;
    }
    .admin-btn.secondary {
        background: #8b7355;
    }
    .admin-btn.secondary:hover {
        background: #6b5d54;
    }
    .admin-btn.success {
        background: #4caf50;
    }
    .admin-btn.success:hover {
        background: #388e3c;
    }
    .admin-btn.delete {
        background: #f44336;
    }
    .admin-btn.delete:hover {
        background: #d32f2f;
    }
    .contest-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
    }
    .contest-card {
        background: #f9f5f0;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 24px rgba(0,0,0,0.07);
        position: relative;
        transition: box-shadow 0.2s;
    }
    .contest-card:hover {
        box-shadow: 0 8px 32px rgba(233, 30, 99, 0.13);
    }
    .contest-card.winner {
        border: 3px solid #4caf50;
    }
    .contest-header {
        padding: 1.5rem;
        background: #e8f5e8;
        border-bottom: 1px solid #c8e6c9;
    }
    .contest-date {
        font-size: 1.2rem;
        font-weight: 600;
        color: #2e7d32;
        margin-bottom: 0.5rem;
    }
    .contest-status {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .status-open {
        background: #e8f5e8;
        color: #2e7d32;
    }
    .status-closed {
        background: #ffebee;
        color: #c62828;
    }
    .candidates-list {
        padding: 1.5rem;
    }
    .candidate-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .candidate-item.winner {
        border: 2px solid #4caf50;
        background: #f1f8e9;
    }
    .candidate-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }
    .candidate-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .candidate-info {
        flex: 1;
    }
    .candidate-uploader {
        font-weight: 600;
        color: #8b7355;
        margin-bottom: 0.2rem;
    }
    .candidate-votes {
        color: #e91e63;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .candidate-actions {
        display: flex;
        gap: 0.5rem;
    }
    .winner-badge {
        background: #4caf50;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .candidate-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
    }
    .candidate-card {
        background: #f9f5f0;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 24px rgba(0,0,0,0.07);
        position: relative;
        transition: box-shadow 0.2s;
    }
    .candidate-card:hover {
        box-shadow: 0 8px 32px rgba(233, 30, 99, 0.13);
    }
    .candidate-card img,
    .candidate-card video {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }
    .candidate-card-info {
        padding: 1rem 1.2rem;
    }
    .candidate-card-uploader {
        color: #8b7355;
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    .candidate-card-votes {
        color: #e91e63;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #8b7355;
        font-weight: 600;
    }
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #e91e63;
    }
</style>
{% endblock %}

{% block content %}
<div class="photo-of-day-admin-header">
    <h1>📸 Photo of the Day Contest Management</h1>
    <p>Manage daily photo contests and select winners</p>
</div>

<!-- DEBUG SECTION -->
<div style="background: #f0f0f0; padding: 1rem; margin: 1rem 0; border-radius: 8px; font-family: monospace; font-size: 0.9rem;">
    <strong>DEBUG INFO:</strong><br>
    Main Contest: {{ main_contest }}<br>
    Main Contest ID: {{ main_contest.id if main_contest else 'None' }}<br>
    Main Contest Active: {{ main_contest.is_active if main_contest else 'None' }}<br>
    Main Candidates Count: {{ main_candidates|length }}<br>
    All Contests Count: {{ all_contests|length }}<br>
    All Photos Count: {{ all_photos|length }}
</div>

<div class="admin-stats-grid">
    <div class="admin-stat-card">
        <div class="stat-value">{{ all_contests|length }}</div>
        <div class="stat-label">Total Contests</div>
    </div>
    <div class="admin-stat-card">
        <div class="stat-value">{{ main_candidates|length }}</div>
        <div class="stat-label">Current Candidates</div>
    </div>
    <div class="admin-stat-card">
        <div class="stat-value">{{ likes_threshold }}</div>
        <div class="stat-label">Auto-Candidate Threshold</div>
    </div>
</div>

<div class="admin-section-card">
    <div class="admin-section-title">Create New Contest</div>
    <div class="contest-controls">
        <button id="create-contest-btn" class="admin-btn primary">Create Today's Contest</button>
        <button id="add-auto-candidates-btn" class="admin-btn secondary">Add Auto-Candidates</button>
        <button id="update-threshold-btn" class="admin-btn secondary">Update Threshold</button>
        <button id="debug-db-btn" class="admin-btn secondary">Debug Database</button>
    </div>
    
    <div id="create-contest-form" style="display: none; background: #f9f5f0; padding: 2rem; border-radius: 15px; margin-top: 1rem;">
        <div class="form-group">
            <label for="contest-date">Contest Date:</label>
            <input type="date" id="contest-date" value="{{ today_date }}">
        </div>
        <div class="form-group">
            <label for="voting-ends">Voting Ends (Optional):</label>
            <input type="datetime-local" id="voting-ends">
        </div>
        <button id="submit-contest-btn" class="admin-btn primary">Create Contest</button>
        <button id="cancel-contest-btn" class="admin-btn secondary">Cancel</button>
    </div>
    
    <div id="threshold-form" style="display: none; background: #f9f5f0; padding: 2rem; border-radius: 15px; margin-top: 1rem;">
        <div class="form-group">
            <label for="new-threshold">New Likes Threshold:</label>
            <input type="number" id="new-threshold" value="{{ likes_threshold }}" min="1">
        </div>
        <button id="submit-threshold-btn" class="admin-btn primary">Update Threshold</button>
        <button id="cancel-threshold-btn" class="admin-btn secondary">Cancel</button>
    </div>
    
    <p style="color:#6b5d54; margin-top: 1rem;">
        <strong>Auto-Candidate System:</strong> Photos with {{ likes_threshold }} or more likes are automatically added as candidates for Photo of the Day contests.
    </p>
</div>

<div class="admin-section-card">
    <div class="admin-section-title">Current Main Contest</div>
    <!-- DEBUG: main_contest = {{ main_contest }} -->
    <!-- DEBUG: main_candidates count = {{ main_candidates|length }} -->
    {% if main_contest %}
    <div class="contest-card {% if main_contest.winner_photo_id %}winner{% endif %}">
        <div class="contest-header">
            <div class="contest-date">Main Contest - {{ main_contest.contest_date | timezone_format('%B %d, %Y') }}</div>
            <div class="contest-status {% if main_contest.is_voting_open %}status-open{% else %}status-closed{% endif %}">
                {% if main_contest.is_voting_open %}
                    🗳️ Voting Open
                {% else %}
                    ⏰ Voting Closed
                {% endif %}
            </div>
        </div>
        <div class="candidates-list">
            {% if main_candidates %}
                {% for candidate in main_candidates %}
                <div class="candidate-item {% if candidate.is_winner %}winner{% endif %}">
                    <div class="candidate-thumbnail">
                        {% if candidate.photo.is_photobooth %}
                        <img src="{{ url_for('static', filename='uploads/photobooth/' + candidate.photo.filename) }}" alt="Candidate">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/' + candidate.photo.filename) }}" alt="Candidate">
                        {% endif %}
                    </div>
                    <div class="candidate-info">
                        <div class="candidate-uploader">by {{ candidate.photo.uploader_name }}</div>
                        <div class="candidate-votes">{{ candidate.vote_count }} votes</div>
                    </div>
                    <div class="candidate-actions">
                        {% if candidate.is_winner %}
                            <span class="winner-badge">🏆 Winner</span>
                        {% else %}
                            <button onclick="selectWinner({{ main_contest.id }}, {{ candidate.id }})" class="admin-btn success">Select Winner</button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color:#6b5d54; text-align:center;">No candidates yet</p>
            {% endif %}
        </div>
        <div style="padding: 1rem; border-top: 1px solid #e0e0e0;">
            <button onclick="closeContest()" class="admin-btn secondary">Close Contest</button>
            <button onclick="deleteContest({{ main_contest.id }})" class="admin-btn delete">Delete Contest</button>
        </div>
    </div>
    {% else %}
    <p style="color:#6b5d54; text-align:center;">No active contest. Click "Create Today's Contest" to start one.</p>
    {% endif %}
</div>

<div class="admin-section-card">
    <div class="admin-section-title">Add Photo as Candidate</div>
    <div class="candidate-grid">
        {% for photo in all_photos[:20] %}
        <div class="candidate-card">
            {% if photo.is_photobooth %}
            <img src="{{ url_for('static', filename='uploads/photobooth/' + photo.filename) }}" alt="Photo">
            {% else %}
            <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" alt="Photo">
            {% endif %}
            <div class="candidate-card-info">
                <div class="candidate-card-uploader">by {{ photo.uploader_name }}</div>
                <div class="candidate-card-votes">{{ photo.likes }} likes</div>
                <button onclick="addAsCandidate({{ photo.id }})" class="admin-btn primary">Add as Candidate</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createContestBtn = document.getElementById('create-contest-btn');
    const createContestForm = document.getElementById('create-contest-form');
    const submitContestBtn = document.getElementById('submit-contest-btn');
    const cancelContestBtn = document.getElementById('cancel-contest-btn');
    
    const updateThresholdBtn = document.getElementById('update-threshold-btn');
    const thresholdForm = document.getElementById('threshold-form');
    const submitThresholdBtn = document.getElementById('submit-threshold-btn');
    const cancelThresholdBtn = document.getElementById('cancel-threshold-btn');
    
    const addAutoCandidatesBtn = document.getElementById('add-auto-candidates-btn');
    const debugDbBtn = document.getElementById('debug-db-btn');
    
    createContestBtn.addEventListener('click', function() {
        createContestForm.style.display = 'block';
        thresholdForm.style.display = 'none';
    });
    
    cancelContestBtn.addEventListener('click', function() {
        createContestForm.style.display = 'none';
    });
    
    submitContestBtn.addEventListener('click', function() {
        console.log('Creating contest...');  // Debug line
        
        fetch('/admin/photo-of-day/create-contest?key=wedding2024', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'create_main_contest'
            })
        })
        .then(response => {
            console.log('Create contest response status:', response.status);  // Debug line
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || `HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Create contest response data:', data);  // Debug line
            if (data.success) {
                showNotification('Main contest created successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message || 'Unknown error occurred', 'error');
            }
        })
        .catch(error => {
            console.error('Create contest error:', error);
            showNotification(`Error: ${error.message}`, 'error');
        });
    });
    
    updateThresholdBtn.addEventListener('click', function() {
        thresholdForm.style.display = 'block';
        createContestForm.style.display = 'none';
    });
    
    cancelThresholdBtn.addEventListener('click', function() {
        thresholdForm.style.display = 'none';
    });
    
    submitThresholdBtn.addEventListener('click', function() {
        const threshold = document.getElementById('new-threshold').value;
        
        fetch('/admin/photo-of-day/update-threshold?key=wedding2024', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                threshold: threshold
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Threshold updated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    });
    
    addAutoCandidatesBtn.addEventListener('click', function() {
        fetch('/admin/photo-of-day/add-auto-candidates?key=wedding2024', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred', 'error');
        });
    });
    
    debugDbBtn.addEventListener('click', function() {
        fetch('/admin/photo-of-day/debug-db?key=wedding2024', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Database Debug Info:', data);
                showNotification(`Database: ${data.total_contests} contests, ${data.total_candidates} candidates`, 'success');
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Debug error:', error);
            showNotification('Debug error occurred', 'error');
        });
    });
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notification.style.fontSize = '1rem';
        notification.style.fontWeight = '600';
        notification.style.minWidth = '300px';
        notification.style.maxWidth = '500px';
        notification.style.wordWrap = 'break-word';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds for better visibility
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
});

function selectWinner(contestId, candidateId) {
    if (!confirm('Are you sure you want to select this photo as the winner?')) {
        return;
    }
    
    fetch('/admin/photo-of-day/select-winner?key=wedding2024', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            contest_id: contestId,
            candidate_id: candidateId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Winner selected successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred', 'error');
    });
}

function closeContest() {
    if (!confirm('Are you sure you want to close the current contest? This will allow you to create a new one.')) {
        return;
    }
    
    fetch('/admin/photo-of-day/close-contest?key=wedding2024', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Contest closed successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred', 'error');
    });
}

function deleteContest(contestId) {
    if (!confirm('Are you sure you want to delete this contest?')) {
        return;
    }
    
    fetch(`/admin/photo-of-day/delete-contest/${contestId}?key=wedding2024`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Contest closed successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred', 'error');
    });
}

function addAsCandidate(photoId) {
    console.log('Adding photo as candidate:', photoId);  // Debug line
    
    fetch('/admin/photo-of-day/add-candidate?key=wedding2024', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            photo_id: photoId
        })
    })
    .then(response => {
        console.log('Response status:', response.status);  // Debug line
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);  // Debug line
        if (data.success) {
            showNotification('Photo added as candidate successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message || 'Unknown error occurred', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(`Error: ${error.message}`, 'error');
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %} 