{% extends "base.html" %}

{% block title %}Admin Dashboard - Wedding Gallery{% endblock %}

{% block extra_styles %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #2c2c2c 0%, #4a4a4a 100%);
        color: white;
        padding: 3rem 0;
        margin: -3rem -20px 3rem -20px;
        text-align: center;
    }

    .admin-header h2 {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .admin-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 3rem;
        flex-wrap: wrap;
    }

    .admin-actions .btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
    }

    .batch-download-btn {
        background: #28a745;
        color: white;
    }

    .batch-download-btn:hover {
        background: #218838;
    }

    .system-reset-btn {
        background: #dc3545;
        color: white;
    }

    .system-reset-btn:hover {
        background: #c82333;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-value {
        font-size: 3rem;
        font-weight: 700;
        color: #8b7355;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: #6b5d54;
        font-size: 1.1rem;
    }

    .section-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 3rem;
    }

    .section-header {
        background: #f9f5f0;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e8ddd3;
    }

    .section-header h3 {
        color: #8b7355;
        font-family: 'Playfair Display', serif;
        font-size: 1.8rem;
        margin: 0;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .monitoring-status {
        display: flex;
        align-items: center;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .status-indicator.active {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-indicator.inactive {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }

    .status-indicator.active .status-dot {
        background: #28a745;
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }

    .status-indicator.inactive .status-dot {
        background: #dc3545;
        box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }

    .status-indicator.inactive .status-dot {
        animation: none;
    }

    .section-content {
        padding: 2rem;
    }

    .border-upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    .upload-area {
        background: #f9f5f0;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
    }

    .current-border {
        background: #faf9f7;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
    }

    .current-border img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }

    .no-border {
        padding: 3rem;
        color: #999;
        font-style: italic;
    }

    .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
    }

    .file-upload-wrapper input[type=file] {
        position: absolute;
        left: -9999px;
    }

    .file-upload-label {
        display: block;
        padding: 2rem;
        background: white;
        border: 2px dashed #8b7355;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .file-upload-label:hover {
        background: #faf9f7;
        border-color: #6b5d54;
    }

    .file-upload-label svg {
        width: 50px;
        height: 50px;
        fill: #8b7355;
        margin-bottom: 1rem;
    }

    .photobooth-info {
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        color: #0c5460;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .qr-settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .qr-form-section {
        background: #f9f5f0;
        padding: 1.5rem;
        border-radius: 10px;
    }

    .qr-preview {
        text-align: center;
        padding: 2rem;
        background: #faf9f7;
        border-radius: 10px;
        border: 2px dashed #e8ddd3;
    }

    .qr-preview h4 {
        color: #6b5d54;
        margin-bottom: 1rem;
    }

    .preview-content {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        max-width: 300px;
        margin: 0 auto;
    }

    .preview-title {
        font-family: 'Playfair Display', serif;
        color: #8b7355;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .preview-subtitle {
        color: #6b5d54;
        font-size: 1rem;
        margin-bottom: 1rem;
    }

    .preview-message {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 1rem;
    }

    .preview-couple {
        color: #8b7355;
        font-style: italic;
        margin-top: 1rem;
    }

    .photos-table, .guestbook-table, .messages-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 3rem;
    }

    .table-header {
        background: #f9f5f0;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e8ddd3;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-header h3 {
        color: #8b7355;
        font-family: 'Playfair Display', serif;
        font-size: 1.8rem;
        margin: 0;
    }

    .tab-buttons {
        display: flex;
        gap: 1rem;
    }

    .tab-btn {
        background: #e8ddd3;
        color: #6b5d54;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .tab-btn.active {
        background: #8b7355;
        color: white;
    }

    .tab-btn:hover {
        transform: translateY(-2px);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: #f9f5f0;
        padding: 1rem;
        text-align: left;
        color: #6b5d54;
        font-weight: 600;
        border-bottom: 2px solid #e8ddd3;
    }

    td {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
    }

    tr:hover {
        background: #faf9f7;
    }

    .photo-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 10px;
    }

    .photobooth-badge {
        background: #17a2b8;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }

    .video-badge {
        background: #6f42c1;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }

    .delete-btn, .hide-btn, .show-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }

    .delete-btn:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .hide-btn {
        background: #ffc107;
        color: #212529;
    }

    .hide-btn:hover {
        background: #e0a800;
    }

    .show-btn {
        background: #28a745;
    }

    .show-btn:hover {
        background: #218838;
    }

    .edit-btn {
        background: #8b7355;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }

    .edit-btn:hover {
        background: #6b5d54;
        transform: translateY(-2px);
    }

    .admin-notice {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .admin-notice svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
        flex-shrink: 0;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: none;
    }

    .guestbook-message, .message-content {
        max-width: 300px;
        line-height: 1.5;
        color: #666;
    }

    .guestbook-location {
        color: #999;
        font-style: italic;
        font-size: 0.9rem;
    }

    .hidden-indicator {
        background: #ffc107;
        color: #212529;
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .message-comments {
        margin-top: 0.5rem;
        padding-left: 1rem;
        border-left: 2px solid #e8ddd3;
    }

    .comment-item {
        background: #f9f5f0;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border-radius: 5px;
        font-size: 0.9rem;
    }

    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }

    .modal-content {
        background: white;
        max-width: 500px;
        margin: 50px auto;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
        margin-bottom: 1.5rem;
    }

    .modal-header h3 {
        color: #8b7355;
        font-family: 'Playfair Display', serif;
        font-size: 1.8rem;
        margin: 0;
    }

    .modal-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .confirmation-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e8ddd3;
        border-radius: 10px;
        font-size: 1rem;
        margin: 1rem 0;
    }

    .confirmation-input:focus {
        outline: none;
        border-color: #dc3545;
    }

    .warning-text {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
        border: 1px solid #f5c6cb;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .loading-content {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #8b7355;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .admin-header {
            margin: -3rem -1.5rem 3rem -1.5rem;
        }

        .qr-settings-grid, .border-upload-section {
            grid-template-columns: 1fr;
        }

        table {
            font-size: 0.9rem;
        }

        .photo-thumbnail {
            width: 40px;
            height: 40px;
        }

        th, td {
            padding: 0.75rem 0.5rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .guestbook-message, .message-content {
            max-width: 200px;
        }

        .tab-buttons {
            flex-wrap: wrap;
        }

        .admin-actions {
            flex-direction: column;
            align-items: center;
        }

        .admin-actions .btn {
            width: 100%;
            max-width: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h2>Admin Dashboard</h2>
    <p>Manage wedding gallery photos, messages, and statistics</p>
</div>

<div class="container">
    <div class="admin-notice">
        <svg viewBox="0 0 24 24">
            <path d="M12,2L1,21H23M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/>
        </svg>
        <div>
            <strong>Security Notice:</strong> This admin panel is protected by a simple key. For production use, implement proper authentication.
        </div>
    </div>

    <!-- Admin Action Buttons -->
    <div class="admin-actions">
        <button class="btn batch-download-btn" onclick="batchDownload()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z" fill="currentColor"/>
            </svg>
            Download All Content
        </button>
        <button class="btn system-reset-btn" onclick="showResetModal()">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M12,4C14.1,4 16.1,4.8 17.6,6.3C20.7,9.4 20.7,14.5 17.6,17.6C16.1,19.1 14.1,19.9 12,19.9C9.9,19.9 7.9,19.1 6.4,17.6C5.6,16.8 5,15.9 4.6,14.9C4.2,13.9 4,12.9 4,11.9C4,10.9 4.2,9.9 4.6,8.9L6.1,9.6C5.8,10.4 5.6,11.2 5.6,11.9C5.6,12.6 5.7,13.3 6,14C6.2,14.6 6.6,15.2 7,15.7C8.2,16.9 9.9,17.5 11.7,17.5C13.5,17.5 15.2,16.9 16.4,15.7C18.8,13.3 18.8,9.4 16.4,7C15.2,5.8 13.5,5.2 11.7,5.2C10.7,5.2 9.7,5.4 8.8,5.9L10.4,4.3L9,2.9L5.1,6.8L9,10.7L10.4,9.3L8.8,7.7C9.4,7.4 10.1,7.2 10.8,7.2C11.9,7.2 12.9,7.6 13.7,8.4C15.3,10 15.3,12.7 13.7,14.3C12.9,15.1 11.9,15.5 10.8,15.5C9.7,15.5 8.7,15.1 7.9,14.3C7.5,13.9 7.2,13.4 7.1,12.8C7,12.2 7,11.6 7.1,11L5.6,10.3C5.2,11.1 5,12 5,12.9C5,14.1 5.4,15.2 6.1,16.1C7.3,18.1 9.5,19.3 12,19.3C14.5,19.3 16.7,18.1 17.9,16.1C19.1,14.1 19.1,11.6 17.9,9.6C16.7,7.6 14.5,6.4 12,6.4V4Z" fill="currentColor"/>
            </svg>
            System Reset
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_photos }}</div>
            <div class="stat-label">Total Photos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_likes }}</div>
            <div class="stat-label">Total Likes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_comments }}</div>
            <div class="stat-label">Photo Comments</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_guestbook }}</div>
            <div class="stat-label">Guestbook Entries</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_messages }}</div>
            <div class="stat-label">Message Board Posts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ photobooth_count }}</div>
            <div class="stat-label">Photobooth Photos</div>
        </div>
    </div>

    <!-- Virtual Photobooth Settings -->
    <div class="section-card">
        <div class="section-header">
            <h3>Virtual Photobooth Settings</h3>
        </div>
        <div class="section-content">
            <div class="photobooth-info">
                <strong>üì∏ Virtual Photobooth Feature:</strong> Guests can take photos with their camera and apply your custom wedding border. They can then download the photo or upload it directly to the gallery.
            </div>
            
            <div class="border-upload-section">
                <div class="upload-area">
                    <h4 style="color: #8b7355; margin-bottom: 1.5rem;">Upload Wedding Border</h4>
                    <p style="color: #666; margin-bottom: 1.5rem;">
                        Upload a PNG image with transparent areas where the photo will show through. 
                        Recommended size: 1280x720px or 16:9 aspect ratio.
                    </p>
                    
                    <form id="borderUploadForm">
                        <div class="file-upload-wrapper">
                            <input type="file" 
                                   id="borderFile" 
                                   accept="image/png,image/jpg,image/jpeg,image/webp"
                                   onchange="uploadBorder(this)">
                            <label for="borderFile" class="file-upload-label">
                                <svg viewBox="0 0 24 24">
                                    <path d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z"/>
                                </svg>
                                <p>Click to upload border image</p>
                                <small>PNG with transparency recommended</small>
                            </label>
                        </div>
                    </form>
                </div>
                
                <div class="current-border">
                    <h4 style="color: #8b7355; margin-bottom: 1.5rem;">Current Border</h4>
                    {% if border_settings.get('border_url') %}
                        <img src="{{ border_settings.get('border_url') }}" alt="Current wedding border">
                        <p style="color: #666; font-size: 0.9rem;">
                            Border uploaded successfully!<br>
                            <a href="{{ url_for('photobooth') }}" target="_blank" class="btn btn-secondary" style="margin-top: 1rem;">
                                View Photobooth
                            </a>
                        </p>
                    {% else %}
                        <div class="no-border">
                            No border uploaded yet
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Generator Section -->
    <div class="section-card">
        <div class="section-header">
            <h3>QR Code Generator</h3>
        </div>
        <div class="section-content">
            <div class="success-message" id="successMessage">
                Settings saved successfully!
            </div>
            
            <div class="form-group">
                <label for="public_url">Public Gallery URL</label>
                <input type="text" 
                       id="public_url" 
                       placeholder="https://your-domain.com/gallery"
                       value="{{ public_url }}"
                       class="form-control">
                <small style="color: #666; display: block; margin-top: 0.5rem;">
                    Enter the public URL where guests can access the photo gallery
                </small>
            </div>

            <div class="qr-settings-grid">
                <div class="qr-form-section">
                    <h4 style="color: #8b7355; margin-bottom: 1.5rem;">PDF Content Settings</h4>
                    
                    <div class="form-group">
                        <label for="qr_title">Title</label>
                        <input type="text" 
                               id="qr_title" 
                               placeholder="Share Your Wedding Photos!"
                               value="{{ qr_settings.get('title', 'Share Your Wedding Photos!') }}">
                    </div>

                    <div class="form-group">
                        <label for="qr_subtitle">Subtitle</label>
                        <input type="text" 
                               id="qr_subtitle" 
                               placeholder="Scan to Upload & View Photos"
                               value="{{ qr_settings.get('subtitle', 'Scan to Upload & View Photos') }}">
                    </div>

                    <div class="form-group">
                        <label for="qr_message">Message</label>
                        <textarea id="qr_message" 
                                  placeholder="We would love to see the wedding through your eyes..."
                                  rows="4">{{ qr_settings.get('message', 'We would love to see the wedding through your eyes! Please scan the QR code below to upload your photos and view the gallery.') }}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="couple_names">Couple Names</label>
                        <input type="text" 
                               id="couple_names" 
                               placeholder="Sarah & John"
                               value="{{ qr_settings.get('couple_names', 'The Happy Couple') }}">
                    </div>
                </div>

                <div class="qr-preview">
                    <h4>Preview</h4>
                    <div class="preview-content">
                        <div class="preview-title" id="previewTitle">Share Your Wedding Photos!</div>
                        <div class="preview-subtitle" id="previewSubtitle">Scan to Upload & View Photos</div>
                        <div class="preview-message" id="previewMessage">We would love to see the wedding through your eyes! Please scan the QR code below to upload your photos and view the gallery.</div>
                        <div style="margin: 1rem 0; padding: 2rem; background: #f0f0f0; border-radius: 10px;">
                            <small style="color: #999;">QR Code</small>
                        </div>
                        <div class="preview-couple">
                            With love,<br>
                            <span id="previewCouple">The Happy Couple</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="saveAllSettings()">Save Settings</button>
                <button class="btn btn-secondary" onclick="generatePDF()">Generate PDF</button>
            </div>
        </div>
    </div>

    <!-- Welcome Modal Settings Section -->
    <div class="section-card">
        <div class="section-header">
            <h3>Welcome Modal Settings</h3>
        </div>
        <div class="section-content">
            <div class="qr-settings-grid">
                <div class="qr-form-section">
                    <h4 style="color: #8b7355; margin-bottom: 1.5rem;">Modal Content</h4>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" 
                                   id="modal_enabled" 
                                   {% if welcome_settings.get('enabled', True) %}checked{% endif %}>
                            Enable Welcome Modal
                        </label>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" 
                                   id="modal_show_once" 
                                   {% if welcome_settings.get('show_once', True) %}checked{% endif %}>
                            Show Only Once per User
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="modal_title">Modal Title</label>
                        <input type="text" 
                               id="modal_title" 
                               placeholder="Welcome to Our Wedding Gallery!"
                               value="{{ welcome_settings.get('title', 'Welcome to Our Wedding Gallery!') }}">
                    </div>

                    <div class="form-group">
                        <label for="modal_message">Welcome Message</label>
                        <textarea id="modal_message" 
                                  placeholder="Thank you for celebrating with us..."
                                  rows="4">{{ welcome_settings.get('message', 'Thank you so much for celebrating with us! We\'d love to see the wedding through your eyes. Feel free to upload your photos and browse the gallery.') }}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="couple_photo_url">Couple Photo URL (optional)</label>
                        <input type="text" 
                               id="couple_photo_url" 
                               placeholder="https://example.com/our-photo.jpg"
                               value="{{ welcome_settings.get('couple_photo', '') }}">
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            Enter a URL to your couple photo to display in the modal
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Instructions (one per line)</label>
                        <textarea id="modal_instructions" 
                                  placeholder="Click Upload Photo to share your pictures&#10;Browse the gallery to see all photos"
                                  rows="6">{% for inst in welcome_settings.get('instructions', ['Click "Upload Photo" to share your pictures', 'Browse the gallery to see all photos', 'Click on any photo to like or comment', 'No login required - just add your name when uploading or commenting']) %}{{ inst }}
{% endfor %}</textarea>
                    </div>
                </div>

                <div class="qr-preview">
                    <h4>Preview</h4>
                    <div class="preview-content" style="text-align: left;">
                        <h3 class="preview-title" id="previewModalTitle" style="text-align: center;">Welcome to Our Wedding Gallery!</h3>
                        
                        <div id="previewPhotoContainer" style="margin: 1rem 0; text-align: center; {% if not welcome_settings.get('couple_photo') %}display: none;{% endif %}">
                            <img id="previewCouplePhoto" 
                                 src="{{ welcome_settings.get('couple_photo', '') }}" 
                                 style="max-width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        </div>
                        
                        <p class="preview-message" id="previewModalMessage" style="text-align: center;">Thank you so much for celebrating with us!</p>
                        
                        <div style="background: #f9f5f0; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong style="color: #8b7355;">How to Use:</strong>
                            <ul id="previewInstructions" style="margin: 0.5rem 0 0 1rem; padding-left: 1rem; color: #666;">
                                <li>Click "Upload Photo" to share</li>
                                <li>Browse the gallery</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="saveAllSettings()">Save All Settings</button>
            </div>
        </div>
    </div>

    <!-- Email Photo Upload Settings Section -->
    <div class="section-card">
        <div class="section-header">
            <h3>Email Photo Upload Settings</h3>
            <div class="monitoring-status">
                <div class="status-indicator {% if email_settings.get('enabled', False) and email_settings.get('smtp_username') %}active{% else %}inactive{% endif %}">
                    <span class="status-dot"></span>
                    <span class="status-text">
                        {% if email_settings.get('enabled', False) and email_settings.get('smtp_username') %}
                            üìß Monitoring Active
                        {% else %}
                            ‚è∏Ô∏è Monitoring Inactive
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="section-content">
            <div class="qr-settings-grid">
                <div class="qr-form-section">
                    <h4 style="color: #8b7355; margin-bottom: 1.5rem;">Email Configuration</h4>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" 
                                   id="email_enabled" 
                                   {% if email_settings.get('enabled', False) %}checked{% endif %}>
                            Enable Email Photo Upload
                        </label>
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            When enabled, users can email photos to the configured email address
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="email_monitor_email">Monitor Email Address</label>
                        <input type="email" 
                               id="email_monitor_email" 
                               placeholder="photos@yourdomain.com"
                               value="{{ email_settings.get('monitor_email', '') }}">
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            Email address to monitor for incoming photo uploads
                        </small>
                    </div>

                    <h5 style="color: #8b7355; margin: 2rem 0 1rem 0;">SMTP Settings (for sending emails)</h5>
                    
                    <div class="form-group">
                        <label for="email_smtp_server">SMTP Server</label>
                        <input type="text" 
                               id="email_smtp_server" 
                               placeholder="smtp.gmail.com"
                               value="{{ email_settings.get('smtp_server', 'smtp.gmail.com') }}">
                    </div>

                    <div class="form-group">
                        <label for="email_smtp_port">SMTP Port</label>
                        <input type="number" 
                               id="email_smtp_port" 
                               placeholder="587"
                               value="{{ email_settings.get('smtp_port', '587') }}">
                    </div>

                    <div class="form-group">
                        <label for="email_smtp_username">SMTP Username</label>
                        <input type="email" 
                               id="email_smtp_username" 
                               placeholder="your-email@gmail.com"
                               value="{{ email_settings.get('smtp_username', '') }}">
                    </div>

                    <div class="form-group">
                        <label for="email_smtp_password">SMTP Password</label>
                        <input type="password" 
                               id="email_smtp_password" 
                               placeholder="App password or regular password"
                               value="{{ email_settings.get('smtp_password', '') }}">
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            For Gmail, use an App Password. For other providers, use your regular password.
                        </small>
                    </div>

                    <h5 style="color: #8b7355; margin: 2rem 0 1rem 0;">IMAP Settings (for receiving emails)</h5>
                    
                    <div class="form-group">
                        <label for="email_imap_server">IMAP Server</label>
                        <input type="text" 
                               id="email_imap_server" 
                               placeholder="imap.gmail.com"
                               value="{{ email_settings.get('imap_server', 'imap.gmail.com') }}">
                    </div>

                    <div class="form-group">
                        <label for="email_imap_port">IMAP Port</label>
                        <input type="number" 
                               id="email_imap_port" 
                               placeholder="993"
                               value="{{ email_settings.get('imap_port', '993') }}">
                    </div>

                    <div class="form-group">
                        <label for="email_imap_username">IMAP Username</label>
                        <input type="email" 
                               id="email_imap_username" 
                               placeholder="your-email@gmail.com"
                               value="{{ email_settings.get('imap_username', '') }}">
                    </div>

                    <div class="form-group">
                        <label for="email_imap_password">IMAP Password</label>
                        <input type="password" 
                               id="email_imap_password" 
                               placeholder="App password or regular password"
                               value="{{ email_settings.get('imap_password', '') }}">
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            For Gmail, use an App Password. For other providers, use your regular password.
                        </small>
                    </div>
                </div>

                <div class="qr-preview">
                    <h4>How It Works</h4>
                    <div class="preview-content" style="text-align: left;">
                        <div style="background: #f9f5f0; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong style="color: #8b7355;">Email Upload Process:</strong>
                            <ol style="margin: 0.5rem 0 0 1rem; padding-left: 1rem; color: #666;">
                                <li>Users email photos to the monitor address</li>
                                <li>System checks for photo attachments</li>
                                <li>Photos are automatically added to gallery</li>
                                <li>Confirmation email sent to user</li>
                                <li>Non-photo emails get rejection notice</li>
                            </ol>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong style="color: #28a745;">Accepted Formats:</strong>
                            <ul style="margin: 0.5rem 0 0 1rem; padding-left: 1rem; color: #666;">
                                <li>JPG / JPEG</li>
                                <li>PNG</li>
                                <li>GIF</li>
                                <li>WebP</li>
                            </ul>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #856404;">Setup Notes:</strong>
                            <ul style="margin: 0.5rem 0 0 1rem; padding-left: 1rem; color: #666;">
                                <li>Gmail requires App Passwords</li>
                                <li>Enable "Less secure app access" for some providers</li>
                                <li>Check your email provider's IMAP settings</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="saveAllSettings()">Save Email Settings</button>
                <button class="btn btn-secondary" onclick="startEmailMonitor()">Start Email Monitor</button>
            </div>
        </div>
    </div>

    <!-- Email Processing Log Section -->
    <div class="section-card">
        <div class="section-header">
            <h3>Email Processing Log</h3>
        </div>
        <div class="section-content">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Sender</th>
                            <th>Subject</th>
                            <th>Received</th>
                            <th>Status</th>
                            <th>Photos</th>
                            <th>Response</th>
                            <th>Error</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in email_logs %}
                        <tr>
                            <td>{{ log.sender_email }}</td>
                            <td>{{ log.subject[:50] }}{% if log.subject|length > 50 %}...{% endif %}</td>
                            <td>{{ log.received_at.strftime('%b %d, %Y %H:%M') }}</td>
                            <td>
                                {% if log.status == 'success' %}
                                    <span style="color: #28a745; font-weight: bold;">‚úì Success</span>
                                {% elif log.status == 'rejected' %}
                                    <span style="color: #dc3545; font-weight: bold;">‚úó Rejected</span>
                                {% elif log.status == 'error' %}
                                    <span style="color: #ffc107; font-weight: bold;">‚ö† Error</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.photo_count > 0 %}
                                    <span style="color: #28a745;">{{ log.photo_count }} photo(s)</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if log.response_sent %}
                                    <span style="color: #28a745;">‚úì {{ log.response_type|title }}</span>
                                {% else %}
                                    <span style="color: #dc3545;">‚úó Not sent</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.error_message %}
                                    <span style="color: #dc3545;" title="{{ log.error_message }}">Error</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not email_logs %}
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <p>No email processing logs yet.</p>
                    <p>Emails will appear here once the email monitor is running and processes incoming emails.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Photos & Videos Management -->
    <div class="photos-table">
        <div class="table-header">
            <h3>Photos & Videos Management</h3>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Preview</th>
                        <th>Uploader</th>
                        <th>Upload Date</th>
                        <th>Type</th>
                        <th>Likes</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for photo in photos %}
                    <tr>
                        <td>
                            {% if photo.media_type == 'video' %}
                                {% if photo.thumbnail_filename %}
                                <img src="{{ url_for('static', filename='uploads/thumbnails/' + photo.thumbnail_filename) }}" 
                                     alt="Video thumbnail" 
                                     class="photo-thumbnail">
                                {% else %}
                                <div class="photo-thumbnail" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
                                    <svg viewBox="0 0 24 24" width="30" height="30" fill="#999">
                                        <path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"/>
                                    </svg>
                                </div>
                                {% endif %}
                            {% elif photo.is_photobooth %}
                                <img src="{{ url_for('static', filename='uploads/photobooth/' + photo.filename) }}" 
                                     alt="Photobooth thumbnail" 
                                     class="photo-thumbnail">
                            {% else %}
                                <img src="{{ url_for('static', filename='uploads/' + photo.filename) }}" 
                                     alt="Thumbnail" 
                                     class="photo-thumbnail">
                            {% endif %}
                        </td>
                        <td>{{ photo.uploader_name }}</td>
                        <td>{{ photo.upload_date.strftime('%b %d, %Y') }}</td>
                        <td>
                            {% if photo.media_type == 'video' %}
                                <span class="video-badge">Video</span>
                            {% elif photo.is_photobooth %}
                                <span class="photobooth-badge">Photobooth</span>
                            {% else %}
                                Photo
                            {% endif %}
                        </td>
                        <td>{{ photo.likes }}</td>
                        <td>{{ photo.comments|length }}</td>
                        <td>
                            <button class="delete-btn" 
                                    onclick="confirmDelete({{ photo.id }}, '{{ photo.uploader_name }}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Message Board Management -->
    <div class="messages-table">
        <div class="table-header">
            <h3>Message Board</h3>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showMessageTab('visible')">Visible ({{ visible_messages|length }})</button>
                <button class="tab-btn" onclick="showMessageTab('hidden')">Hidden ({{ hidden_messages|length }})</button>
            </div>
        </div>
        <div class="table-responsive">
            <!-- Visible Messages -->
            <div id="visible-messages" class="tab-content active">
                <table>
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Message</th>
                            <th>Photo</th>
                            <th>Date</th>
                            <th>Likes</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in visible_messages %}
                        <tr>
                            <td>{{ message.author_name }}</td>
                            <td class="message-content">
                                {{ message.content[:100] }}{% if message.content|length > 100 %}...{% endif %}
                                {% if message.message_comments %}
                                <div class="message-comments">
                                    {% for comment in message.message_comments[:2] %}
                                        {% if not comment.is_hidden %}
                                        <div class="comment-item">
                                            <strong>{{ comment.commenter_name }}:</strong> {{ comment.content[:50] }}{% if comment.content|length > 50 %}...{% endif %}
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                    {% if message.message_comments|length > 2 %}
                                    <small style="color: #999;">... and {{ message.message_comments|length - 2 }} more</small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if message.photo_filename %}
                                <img src="{{ url_for('static', filename='uploads/messages/' + message.photo_filename) }}" 
                                     alt="Photo" 
                                     class="photo-thumbnail"
                                     style="cursor: pointer;"
                                     onclick="window.open(this.src, '_blank')">
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ message.created_at.strftime('%b %d, %Y') }}</td>
                            <td>{{ message.likes }}</td>
                            <td>{{ message.message_comments|selectattr('is_hidden', 'false')|list|length }}</td>
                            <td>
                                <button class="hide-btn" 
                                        onclick="toggleMessageVisibility({{ message.id }})">
                                    Hide
                                </button>
                                <button class="delete-btn" 
                                        onclick="confirmDeleteMessage({{ message.id }}, '{{ message.author_name|e }}')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Hidden Messages -->
            <div id="hidden-messages" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Author</th>
                            <th>Message</th>
                            <th>Photo</th>
                            <th>Date</th>
                            <th>Reason Hidden</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for message in hidden_messages %}
                        <tr>
                            <td>{{ message.author_name }}</td>
                            <td class="message-content">{{ message.content[:100] }}{% if message.content|length > 100 %}...{% endif %}</td>
                            <td>
                                {% if message.photo_filename %}
                                <img src="{{ url_for('static', filename='uploads/messages/' + message.photo_filename) }}" 
                                     alt="Photo" 
                                     class="photo-thumbnail"
                                     style="cursor: pointer;"
                                     onclick="window.open(this.src, '_blank')">
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ message.created_at.strftime('%b %d, %Y') }}</td>
                            <td>Hidden by admin</td>
                            <td>
                                <button class="show-btn" 
                                        onclick="toggleMessageVisibility({{ message.id }})">
                                    Show
                                </button>
                                <button class="delete-btn" 
                                        onclick="confirmDeleteMessage({{ message.id }}, '{{ message.author_name|e }}')">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Guestbook Management -->
    <div class="guestbook-table">
        <div class="table-header">
            <h3>Guestbook Entries</h3>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Message</th>
                        <th>Location</th>
                        <th>Photo</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in guestbook_entries %}
                    <tr>
                        <td>{{ entry.name }}</td>
                        <td class="guestbook-message">{{ entry.message[:100] }}{% if entry.message|length > 100 %}...{% endif %}</td>
                        <td>
                            {% if entry.location %}
                                <span class="guestbook-location">{{ entry.location }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.photo_filename %}
                            <img src="{{ url_for('static', filename='uploads/guestbook/' + entry.photo_filename) }}" 
                                 alt="Photo" 
                                 class="photo-thumbnail"
                                 style="cursor: pointer;"
                                 onclick="window.open(this.src, '_blank')">
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>{{ entry.created_at.strftime('%b %d, %Y') }}</td>
                        <td>
                            <button class="edit-btn" 
                                    onclick="editGuestbookEntry({{ entry.id }}, '{{ entry.name|e }}', {{ entry.message|tojson }}, '{{ entry.location or '' }}')">
                                Edit
                            </button>
                            <button class="delete-btn" 
                                    onclick="confirmDeleteGuestbook({{ entry.id }}, '{{ entry.name }}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Guestbook Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Guestbook Entry</h3>
        </div>
        <form id="editForm">
            <input type="hidden" id="editEntryId">
            <div class="form-group">
                <label for="editName">Name</label>
                <input type="text" id="editName" required>
            </div>
            <div class="form-group">
                <label for="editLocation">Location</label>
                <input type="text" id="editLocation">
            </div>
            <div class="form-group">
                <label for="editMessage">Message</label>
                <textarea id="editMessage" rows="6" required></textarea>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- System Reset Modal -->
<div class="modal-overlay" id="resetModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>System Reset</h3>
        </div>
        <div class="warning-text">
            <strong>‚ö†Ô∏è WARNING:</strong> This will permanently delete ALL data including:
            <ul style="margin: 0.5rem 0; padding-left: 1rem;">
                <li>All uploaded photos and videos</li>
                <li>All guestbook entries</li>
                <li>All message board posts</li>
                <li>All comments and likes</li>
                <li>All photobooth photos</li>
                <li>All settings and configurations</li>
            </ul>
            This action CANNOT be undone!
        </div>
        <p>To confirm this destructive action, please type <strong>"RESET EVERYTHING"</strong> in the box below:</p>
        <input type="text" 
               id="resetConfirmation" 
               class="confirmation-input"
               placeholder="Type: RESET EVERYTHING">
        <div class="modal-buttons">
            <button class="btn system-reset-btn" onclick="confirmSystemReset()" id="confirmResetBtn" disabled>
                Reset System
            </button>
            <button class="btn btn-secondary" onclick="closeResetModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <p id="loadingMessage">Processing...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Upload border functionality
    async function uploadBorder(input) {
        const file = input.files[0];
        if (!file) return;
        
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        const formData = new FormData();
        formData.append('border', file);
        
        try {
            const response = await fetch(`/admin/upload-border?key=${key}`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update the current border display
                const currentBorderDiv = document.querySelector('.current-border');
                currentBorderDiv.innerHTML = `
                    <h4 style="color: #8b7355; margin-bottom: 1.5rem;">Current Border</h4>
                    <img src="${data.border_url}" alt="Current wedding border">
                    <p style="color: #666; font-size: 0.9rem;">
                        Border uploaded successfully!<br>
                        <a href="/photobooth" target="_blank" class="btn btn-secondary" style="margin-top: 1rem;">
                            View Photobooth
                        </a>
                    </p>
                `;
                
                alert('Border uploaded successfully!');
            } else {
                alert('Error uploading border: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error uploading border: ' + error.message);
        }
        
        // Reset the input
        input.value = '';
    }

    // Batch download functionality
    function batchDownload() {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        // Show loading overlay
        showLoading('Preparing download...');
        
        // Create a temporary link and click it
        const link = document.createElement('a');
        link.href = `/admin/batch-download?key=${key}`;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Hide loading after a delay
        setTimeout(() => {
            hideLoading();
        }, 2000);
    }

    // System reset functionality
    function showResetModal() {
        document.getElementById('resetModal').style.display = 'block';
        document.getElementById('resetConfirmation').value = '';
        document.getElementById('confirmResetBtn').disabled = true;
    }

    function closeResetModal() {
        document.getElementById('resetModal').style.display = 'none';
    }

    // Enable/disable reset button based on confirmation text
    document.getElementById('resetConfirmation').addEventListener('input', function(e) {
        const confirmBtn = document.getElementById('confirmResetBtn');
        confirmBtn.disabled = e.target.value !== 'RESET EVERYTHING';
    });

    async function confirmSystemReset() {
        const confirmation = document.getElementById('resetConfirmation').value;
        
        if (confirmation !== 'RESET EVERYTHING') {
            alert('Please type "RESET EVERYTHING" to confirm.');
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        showLoading('Resetting system...');
        closeResetModal();
        
        try {
            const response = await fetch(`/admin/system-reset?key=${key}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    confirmation: confirmation
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                hideLoading();
                alert('System reset completed successfully! The page will now reload.');
                window.location.reload();
            } else {
                hideLoading();
                alert('Error during reset: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            hideLoading();
            alert('Error during reset: ' + error.message);
        }
    }

    // Loading overlay functions
    function showLoading(message = 'Loading...') {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Tab functionality for messages
    function showMessageTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.getElementById(tabName + '-messages').classList.add('active');
        event.target.classList.add('active');
    }

    // Preview updates for QR settings
    document.getElementById('qr_title').addEventListener('input', function(e) {
        document.getElementById('previewTitle').textContent = e.target.value || 'Share Your Wedding Photos!';
    });

    document.getElementById('qr_subtitle').addEventListener('input', function(e) {
        document.getElementById('previewSubtitle').textContent = e.target.value || 'Scan to Upload & View Photos';
    });

    document.getElementById('qr_message').addEventListener('input', function(e) {
        document.getElementById('previewMessage').textContent = e.target.value || 'We would love to see the wedding through your eyes!';
    });

    document.getElementById('couple_names').addEventListener('input', function(e) {
        document.getElementById('previewCouple').textContent = e.target.value || 'The Happy Couple';
    });

    // Preview updates for Welcome Modal
    document.getElementById('modal_title').addEventListener('input', function(e) {
        document.getElementById('previewModalTitle').textContent = e.target.value || 'Welcome to Our Wedding Gallery!';
    });

    document.getElementById('modal_message').addEventListener('input', function(e) {
        document.getElementById('previewModalMessage').textContent = e.target.value || 'Thank you so much for celebrating with us!';
    });

    document.getElementById('couple_photo_url').addEventListener('input', function(e) {
        const url = e.target.value;
        const container = document.getElementById('previewPhotoContainer');
        const img = document.getElementById('previewCouplePhoto');
        
        if (url) {
            img.src = url;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    });

    document.getElementById('modal_instructions').addEventListener('input', function(e) {
        const instructions = e.target.value.split('\n').filter(line => line.trim());
        const list = document.getElementById('previewInstructions');
        list.innerHTML = instructions.map(inst => `<li>${inst}</li>`).join('');
    });

    function saveAllSettings() {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        const instructions = document.getElementById('modal_instructions').value
            .split('\n')
            .filter(line => line.trim())
            .map(line => line.trim());
        
        const settings = {
            public_url: document.getElementById('public_url').value,
            qr_settings: {
                title: document.getElementById('qr_title').value,
                subtitle: document.getElementById('qr_subtitle').value,
                message: document.getElementById('qr_message').value,
                couple_names: document.getElementById('couple_names').value
            },
            welcome_settings: {
                enabled: document.getElementById('modal_enabled').checked,
                show_once: document.getElementById('modal_show_once').checked,
                title: document.getElementById('modal_title').value,
                message: document.getElementById('modal_message').value,
                couple_photo: document.getElementById('couple_photo_url').value,
                instructions: instructions
            },
            email_settings: {
                enabled: document.getElementById('email_enabled').checked,
                monitor_email: document.getElementById('email_monitor_email').value,
                smtp_server: document.getElementById('email_smtp_server').value,
                smtp_port: document.getElementById('email_smtp_port').value,
                smtp_username: document.getElementById('email_smtp_username').value,
                smtp_password: document.getElementById('email_smtp_password').value,
                imap_server: document.getElementById('email_imap_server').value,
                imap_port: document.getElementById('email_imap_port').value,
                imap_username: document.getElementById('email_imap_username').value,
                imap_password: document.getElementById('email_imap_password').value
            }
        };

        fetch(`/admin/save-settings?key=${key}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('successMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('successMessage').style.display = 'none';
                }, 3000);
            }
        });
    }

    function startEmailMonitor() {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        fetch(`/admin/start-email-monitor?key=${key}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Email monitor started successfully!');
            } else {
                alert('Error starting email monitor: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error starting email monitor: ' + error);
        });
    }

    // Update monitoring status indicator
    function updateMonitoringStatus() {
        const enabled = document.getElementById('email_enabled').checked;
        const username = document.getElementById('email_smtp_username').value.trim();
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = statusIndicator.querySelector('.status-text');
        
        if (enabled && username) {
            statusIndicator.className = 'status-indicator active';
            statusText.innerHTML = 'üìß Monitoring Active';
        } else {
            statusIndicator.className = 'status-indicator inactive';
            statusText.innerHTML = '‚è∏Ô∏è Monitoring Inactive';
        }
    }

    // Add event listeners for email settings changes
    document.getElementById('email_enabled').addEventListener('change', updateMonitoringStatus);
    document.getElementById('email_smtp_username').addEventListener('input', updateMonitoringStatus);

    function generatePDF() {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        
        const publicUrl = document.getElementById('public_url').value;
        if (!publicUrl) {
            alert('Please enter a public URL first');
            return;
        }

        // Save settings first, then generate PDF
        saveAllSettings();
        
        setTimeout(() => {
            window.location.href = `/admin/generate-qr-pdf?key=${key}`;
        }, 500);
    }

    function confirmDelete(photoId, uploaderName) {
        if (confirm(`Are you sure you want to delete the photo/video uploaded by ${uploaderName}? This action cannot be undone.`)) {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            window.location.href = `/admin/delete/${photoId}?key=${key}`;
        }
    }

    function confirmDeleteGuestbook(entryId, name) {
        if (confirm(`Are you sure you want to delete the guestbook entry by ${name}? This action cannot be undone.`)) {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            window.location.href = `/admin/delete-guestbook/${entryId}?key=${key}`;
        }
    }

    function toggleMessageVisibility(messageId) {
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        window.location.href = `/admin/toggle-message/${messageId}?key=${key}`;
    }

    function confirmDeleteMessage(messageId, authorName) {
        if (confirm(`Are you sure you want to delete the message by ${authorName}? This action cannot be undone.`)) {
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            window.location.href = `/admin/delete-message/${messageId}?key=${key}`;
        }
    }

    function editGuestbookEntry(id, name, message, location) {
        document.getElementById('editEntryId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editMessage').value = message;
        document.getElementById('editLocation').value = location;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // Handle edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const urlParams = new URLSearchParams(window.location.search);
        const key = urlParams.get('key');
        const entryId = document.getElementById('editEntryId').value;
        
        const data = {
            name: document.getElementById('editName').value,
            message: document.getElementById('editMessage').value,
            location: document.getElementById('editLocation').value
        };

        fetch(`/admin/edit-guestbook/${entryId}?key=${key}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            }
        });
    });

    // Initialize preview on load
    document.getElementById('modal_instructions').dispatchEvent(new Event('input'));

    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            e.target.style.display = 'none';
        }
    });
</script>
{% endblock %}